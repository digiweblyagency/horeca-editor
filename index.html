<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HORECA Editor Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; }
        
        /* Controls (Left) */
        .controls { width: 380px; background: white; padding: 20px; overflow-y: auto; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 15px; box-shadow: 4px 0 15px rgba(0,0,0,0.05); z-index: 20; }
        .section-title { font-size: 0.95rem; font-weight: 700; color: #1e3a8a; border-bottom: 2px solid #eff6ff; padding-bottom: 5px; margin-top: 10px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Preview (Right) */
        .preview-area { flex-grow: 1; padding: 40px; overflow-y: auto; display: flex; justify-content: center; background: #64748b; }
        
        /* The Paper Container */
        #pages-container { display: flex; flex-direction: column; gap: 30px; align-items: center; }

        /* The Paper */
        .a4-page {
            background: white;
            width: 210mm;
            min-height: 297mm; /* Standard A4 Height */
            height: 297mm;
            /* Reduced padding for better use of space */
            padding: 5mm 10mm; 
            box-shadow: 0 0 25px rgba(0,0,0,0.25);
            position: relative;
            font-family: 'Arial', sans-serif;
            color: #333;
            font-size: 10pt;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            transform-origin: top center; /* Crucial for mobile scaling */
        }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 50;
            display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        .modal-content {
            background: white; width: 90%; max-width: 1000px; max-height: 90vh;
            border-radius: 12px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-btn { font-size: 24px; cursor: pointer; color: #666; font-weight: bold; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* TOAST NOTIFICATION */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* HEADER DESIGN - SUPER COMPACT */
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; } 
        .logo-area { width: 45%; }
        .logo-img { max-width: 180px; max-height: 80px; object-fit: contain; display: block; margin-bottom: 2px; }
        .vendor-details { font-size: 8.5pt; line-height: 1.2; color: #444; }
        .vendor-name { font-weight: bold; font-size: 14pt; color: #1e40af; text-transform: uppercase; margin-bottom: 2px; }

        .client-box { 
            width: 45%; 
            border: 1px solid #94a3b8; 
            border-radius: 4px;
            padding: 6px; 
            background-color: #f8fafc;
            min-height: 90px;
        }
        .client-label { font-size: 8pt; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 2px; }
        
        /* DOC TITLE - COMPACT */
        .doc-title-row { text-align: center; margin-bottom: 5px; }
        .doc-title { font-size: 18pt; font-weight: 800; color: #1e3a8a; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #1e3a8a; display: inline-block; padding-bottom: 1px; }

        /* INFO BAR - COMPACT */
        .info-bar { 
            display: flex; width: 100%; border: 1px solid #cbd5e1; 
            margin-bottom: 5px; border-radius: 4px; overflow: hidden; 
        }
        .info-cell { flex: 1; border-right: 1px solid #cbd5e1; text-align: center; }
        .info-cell:last-child { border-right: none; }
        .info-header { background-color: #e2e8f0; font-size: 7pt; font-weight: bold; padding: 2px; color: #475569; text-transform: uppercase; }
        .info-value { padding: 4px; font-weight: 600; font-size: 8.5pt; color: #0f172a; background: white; }

        /* MAIN TABLE - COMPACT */
        .main-table { width: 100%; border-collapse: collapse; margin-bottom: 0; } 
        .main-table th { 
            background-color: #1e40af; color: white; padding: 4px 3px; 
            font-size: 7.5pt; text-transform: uppercase; border: 1px solid #1e40af; 
        }
        .main-table td { 
            border: 1px solid #e2e8f0; padding: 3px 3px; 
            text-align: center; font-size: 8.5pt; color: #334155;
        }
        .col-art { text-align: left !important; padding-left: 6px !important; font-weight: 600; }
        .row-stripe:nth-child(even) { background-color: #f8fafc; }

        /* CONTENT SPACER (Replaces empty rows) */
        .content-spacer { flex-grow: 1; }

        /* FOOTER TOTALS - COMPACT */
        .footer-area { 
            margin-top: 5px; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 5px; 
        }
        .amount-text { width: 60%; padding-right: 10px; }
        .amount-words { font-style: italic; font-weight: 600; color: #334155; margin-top: 2px; font-size: 9pt; }
        
        .total-box { 
            width: 35%; 
            border: 2px solid #1e40af; 
            border-radius: 6px; 
            overflow: hidden; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .total-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 5px 8px; 
            border-bottom: 1px solid #e2e8f0; 
            background: white;
        }
        .total-row.final { 
            background-color: #1e40af; 
            color: white; 
            border-bottom: none; 
            padding: 6px 8px;
        }
        .total-label { font-weight: bold; font-size: 8pt; text-transform: uppercase; }
        .total-value-group { display: flex; align-items: baseline; gap: 4px; }
        .total-value-main { font-size: 12pt; font-weight: 800; }
        .total-currency { font-size: 8pt; font-weight: 600; opacity: 0.9; }

        /* BOTTOM INFO - COMPACT */
        .bottom-info { 
            border-top: 1px solid #cbd5e1; padding-top: 4px; 
            font-size: 7pt; color: #64748b; 
            display: flex; justify-content: space-between; 
            margin-top: auto; 
        }
        
        /* CONTROLS */
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #d1d5db; 
            border-radius: 6px; 
            font-size: 0.95rem; 
            margin-bottom: 8px; 
            background-color: white;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* TABS (In Modal) */
        .tabs { display: flex; gap: 8px; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 15px; overflow-x: auto; flex-wrap: wrap; }
        .tab { padding: 8px 16px; background: #f1f5f9; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #64748b; white-space: nowrap; transition: 0.2s; border: 1px solid #e2e8f0; }
        .tab:hover { background: #e2e8f0; }
        .tab.active { background: #1e40af; color: white; border-color: #1e40af; }
        
        /* GRID VIEW - IMPROVED FOR PC */
        .prod-grid-view { 
            display: grid; 
            /* Ensure min-width is large enough to prevent squishing */
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            gap: 16px; 
            overflow-y: auto; 
            padding: 10px; 
            height: 55vh; 
            align-content: start; 
        }
        
        /* FIXED CARD LAYOUT - GRID BASED */
        .prod-card-large { 
            background: white; 
            border: 1px solid #e5e7eb; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.2s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); 
            /* Explicit height and grid layout */
            display: grid;
            grid-template-rows: 1fr auto; /* Content takes space, footer is auto sized at bottom */
            min-height: 150px; 
            overflow: hidden;
        }
        .prod-card-large:hover { 
            border-color: #2563eb; 
            transform: translateY(-2px); 
            box-shadow: 0 8px 15px rgba(0,0,0,0.08); 
        }
        
        .card-top { padding: 12px; }

        .card-footer {
            padding: 12px; /* More padding for footer */
            background: white;
            border-top: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 50px;
            gap: 10px; /* Increased Gap between price/controls */
            flex-wrap: wrap; /* Allow wrapping if absolutely necessary but min-width should prevent it */
        }

        /* Ensure controls group stays together */
        .card-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        /* Truncate long text */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;  
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-main { background-color: #1e40af; color: white; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: center; transition: 0.2s; margin-top: auto; }
        .btn-main:hover { background-color: #1e3a8a; }
        .btn-outline { border: 2px solid #1e40af; color: #1e40af; padding: 10px; border-radius: 8px; font-weight: bold; text-align: center; cursor: pointer; background: white; transition: 0.2s; }
        .btn-outline:hover { background: #eff6ff; }
        .hidden { display: none; }
        .page-break-text { text-align: center; font-style: italic; color: #888; margin-top: 10px; font-size: 9pt; }

        /* --- RESPONSIVE CSS --- */
        @media (max-width: 768px) {
            body { height: auto; overflow-y: auto; }
            .app-container { flex-direction: column; height: auto; overflow: visible; }
            
            /* Sidebar becomes top bar */
            .controls { 
                width: 100%; 
                height: auto; 
                border-right: none; 
                border-bottom: 1px solid #e5e7eb;
                padding: 15px;
            }
            
            /* Preview Area */
            .preview-area {
                width: 100%;
                height: auto;
                padding: 15px 5px;
                background: #4b5563;
                min-height: 400px;
                overflow-x: hidden;
            }

            /* Scale PDF preview to fit screen */
            .a4-page {
                transform-origin: top center;
                margin-bottom: 20px;
                /* Initial scale fallback, JS will update this */
                transform: scale(0.45); 
            }

            /* Modal Full Screen on Mobile */
            .modal-content {
                width: 95%;
                max-height: 90vh;
                padding: 15px;
            }
            
            /* 1 Column Grid for Products on Mobile */
            .prod-grid-view {
                grid-template-columns: 1fr;
                gap: 10px;
                height: 60vh; /* More height on mobile */
            }
            
            /* Adjust buttons for touch */
            .btn-main, .btn-outline, button {
                padding: 14px; /* Bigger touch target */
                font-size: 1rem;
            }
        }
        
        /* Specific scaling for very small screens (phones) */
        @media (max-width: 480px) {
            .a4-page {
                transform: scale(0.45); 
                margin-bottom: -140mm; /* Pull up the whitespace caused by scaling */
            }
        }
        
        /* Tablet / Small Desktop scaling */
        @media (min-width: 481px) and (max-width: 850px) {
             .a4-page {
                transform: scale(0.6);
                margin-bottom: -100mm;
            }
        }
        
        /* Remove scale for printing */
        @media print {
            body * { visibility: hidden; }
            #pages-container, #pages-container * { visibility: visible; }
            #pages-container { position: absolute; left: 0; top: 0; width: 100%; margin: 0; }
            .a4-page { 
                margin: 0; 
                margin-bottom: 0; 
                page-break-after: always; 
                page-break-inside: avoid; 
                box-shadow: none; 
                height: 296mm; 
                max-height: 296mm; 
                overflow: hidden; 
                position: relative; 
                transform: none !important; /* RESET SCALE */
            }
            .a4-page:last-child { page-break-after: avoid; margin-bottom: 0; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<!-- TOAST -->
<div id="toast" class="toast">
    <i class="fa-solid fa-check-circle text-green-400 text-xl"></i>
    <span id="toast-message">Produit ajout√© !</span>
</div>

<div class="app-container">
    
    <!-- LEFT SIDEBAR -->
    <div class="controls">
        <div class="flex items-center gap-2 mb-2 text-blue-900">
            <i class="fa-solid fa-layer-group text-xl"></i>
            <span class="font-bold text-lg">HORECA Editor</span>
        </div>

        <!-- 1. DOCUMENT -->
        <div class="section-title">1. Info Document</div>
        <select id="docTypeInput" onchange="updateUI()">
            <option value="Bon de Livraison">Bon de Livraison</option>
            <option value="Facture">Facture</option>
            <option value="Bon d'√âchantillon">BON D‚Äô√âCHANTILLON</option>
        </select>
        
        <div class="grid grid-cols-2 gap-2">
            <input type="date" id="dateInput" onchange="renderInvoice()">
            <input type="text" id="docNumInput" value="2025/001" oninput="renderInvoice()" placeholder="N¬∞ Doc">
        </div>
        
        <input type="text" id="refInput" placeholder="R√©f√©rence Client (Facultatif)" oninput="renderInvoice()">
        <input type="text" id="paymentInput" placeholder="Mode de Paiement" class="hidden" oninput="renderInvoice()">

        <!-- 2. CLIENT -->
        <div class="section-title">2. Client (Sauvegarde Auto)</div>
        
        <label class="block text-xs font-bold text-gray-500 mb-1">Nom / Raison Sociale</label>
        <input type="text" id="clientName" placeholder="Ex: Snack Amine" oninput="renderInvoice()">
        
        <label class="block text-xs font-bold text-gray-500 mb-1">Adresse</label>
        <input type="text" id="clientAddress" placeholder="Ex: 12 Rue des Oliviers, Marrakech" oninput="renderInvoice()">
        
        <label class="block text-xs font-bold text-gray-500 mb-1">I.C.E</label>
        <input type="text" id="clientIce" placeholder="Ex: 00123456789" oninput="renderInvoice()">

        <!-- 3. PRODUCTS ACTION -->
        <div class="section-title">3. Produits</div>
        
        <div onclick="toggleModal(true)" class="btn-outline mb-4">
            <i class="fa-solid fa-box-open mr-2"></i> Ouvrir le Catalogue
        </div>

        <!-- DYNAMIC MANUAL ADD SECTION -->
        <label class="block text-xs font-bold text-gray-500 mb-1">Ajout Rapide / Manuel</label>
        <div class="flex gap-1 mb-1">
            <input id="mName" placeholder="Nom" class="w-2/3 text-xs">
            <!-- Price input visible only for Normal mode -->
            <input id="mPrice" type="number" placeholder="Prix" class="w-1/3 text-xs">
        </div>
        <div class="flex gap-1">
            <!-- Dynamic Unit Input: Text for Normal, Select for Echantillon -->
            <div id="manualUnitContainer" class="w-1/3">
                 <input id="mUnit" placeholder="Unit√©" class="w-full text-xs">
            </div>
            <input id="mCondit" placeholder="Condit" class="w-1/3 text-xs">
            <button onclick="addManual()" class="w-1/3 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300">+</button>
        </div>

        <!-- 4. LOGO -->
        <div class="section-title mt-4">4. Logo</div>
        <input type="file" id="logoUpload" accept="image/*" class="text-xs" onchange="loadLogo(event)">
        <div class="text-xs text-gray-400 mt-1">Logo sauvegard√© automatiquement.</div>

        <div onclick="generatePDF()" class="btn-main">
            <i class="fa-solid fa-file-pdf mr-2"></i> T√©l√©charger PDF
        </div>
    </div>

    <!-- RIGHT PREVIEW -->
    <div class="preview-area">
        <div id="pages-container">
            <!-- Pages will be injected here by JS -->
        </div>
    </div>
</div>

<!-- POPUP MODAL -->
<div id="productModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="text-2xl font-bold text-blue-900">üì¶ Catalogue Produits</h2>
            <div class="close-btn" onclick="toggleModal(false)">√ó</div>
        </div>
        
        <!-- Search Bar -->
        <div class="mb-4">
            <input type="text" id="searchCatalog" placeholder="üîç Rechercher un produit..." oninput="searchProducts()" class="w-full p-3 border rounded shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
        </div>

        <div class="tabs">
            <div class="tab active" onclick="setTab('all', this)">Tous</div>
            <div class="tab" onclick="setTab('boulangerie', this)">ü•ñ Boulangerie</div>
            <div class="tab" onclick="setTab('viennoiserie', this)">ü•ê Viennoiserie</div>
            <div class="tab" onclick="setTab('seminaire', this)">üç∞ S√©minaire</div>
            <div class="tab" onclick="setTab('patisserie', this)">ü•ß P√¢tisserie</div>
            <div class="tab" onclick="setTab('snacking', this)">ü•™ Snacking</div>
            <div class="tab" onclick="setTab('meat', this)">üçó Volaille</div>
            <div class="tab" onclick="setTab('fries', this)">üçü Frites</div>
            <div class="tab" onclick="setTab('ice', this)">üßä Gla√ßons</div>
        </div>

        <div id="catalogArea" class="prod-grid-view"></div>
        
        <div class="mt-4 text-right">
            <button onclick="toggleModal(false)" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Fermer</button>
        </div>
    </div>
</div>

<script>
    // --- DATA ---
    const catalog = {
        boulangerie: [
            { name: "PAIN DE MIE 1, 6KG", unit: "CARTOON", condit: 5, price: 42.12 },
            { name: "GD MOULE FERME PAIN DE MIE 1, 2KG", unit: "CARTOON", condit: 6, price: 31.07 },
            { name: "GD MOULE FERME COMPLET 1, 2KG", unit: "CARTOON", condit: 6, price: 29.91 },
            { name: "PAIN DE MIE ARTISAN 650 GR NATURE", unit: "CARTOON", condit: 8, price: 18.92 },
            { name: "DOUBLE BAGUETTE TRADITION NAT GM", unit: "CARTOON", condit: 40, price: 3.68 },
            { name: "DOUBLE BAGUETTE TRADITION COMPLETE GM", unit: "CARTOON", condit: 40, price: 3.75 },
            { name: "DOUBLE PAIN COMPLET PM", unit: "CARTOON", condit: 90, price: 1.97 },
            { name: "DOUBLE PAIN SEMOULE GM", unit: "CARTOON", condit: 40, price: 4.02 },
            { name: "DOUBLE PAIN COMPLET GM", unit: "CARTOON", condit: 40, price: 3.17 },
            { name: "DOUBLE PAIN SEMOULE PM", unit: "CARTOON", condit: 90, price: 1.88 },
            { name: "BAGUETTE TRADITION PAV", unit: "CARTOON", condit: 20, price: 5.74 },
            { name: "BAGUETTE TRADITION OLV GM", unit: "CARTOON", condit: 20, price: 5.63 },
            { name: "BAGUETINE 60GR", unit: "CARTOON", condit: 80, price: 1.90 },
            { name: "FLUTE ANCIENNE 230G", unit: "CARTOON", condit: 25, price: 3.66 },
            { name: "BAGUETTE TRADITION SES GM", unit: "CARTOON", condit: 20, price: 5.92 },
            { name: "FLUTE OLIVE PLUS", unit: "CARTOON", condit: 30, price: 5.98 },
            { name: "PISTOLET OLIVE PLUS", unit: "CARTOON", condit: 120, price: 1.99 },
            { name: "PISTOLET NAT 50G", unit: "CARTOON", condit: 120, price: 1.23 },
            { name: "FLUTE SES 230G", unit: "CARTOON", condit: 25, price: 5.99 },
            { name: "PISTOLET PAV 50G", unit: "CARTOON", condit: 120, price: 2.00 },
            { name: "PISTOLET SES 50G", unit: "CARTOON", condit: 120, price: 2.14 },
            { name: "PAIN DE MIE ARTISAN 650 GR COMPLET", unit: "CARTOON", condit: 8, price: 20.53 },
            { name: "PISTOLET COMPLET 50G", unit: "CARTOON", condit: 120, price: 1.51 },
            { name: "PAIN SANDWICH VIENNOIS", unit: "CARTOON", condit: 40, price: 4.21 },
            { name: "PAIN SANDWICH PANINI 110G", unit: "CARTOON", condit: 40, price: 3.06 },
            { name: "PAIN MAROCAIN SEMOULE", unit: "CARTOON", condit: 120, price: 1.96 },
            { name: "PAIN MAROCAIN COMPLET", unit: "CARTOON", condit: 120, price: 1.96 },
            { name: "SOFT PAIN BURGER NOIR", unit: "CARTOON", condit: 60, price: 3.76 },
            { name: "SOFT MINI PAIN BURGER", unit: "CARTOON", condit: 160, price: 2.05 }, 
            { name: "SOFT PAIN BURGER XL", unit: "CARTOON", condit: 40, price: 4.43 },
            { name: "SOFT MINI PAIN BURGER (VAR)", unit: "CARTOON", condit: 160, price: 1.61 }, 
            { name: "SOFT PAIN BURGER", unit: "CARTOON", condit: 60, price: 3.01 },
            { name: "DOUBLE PAIN SW TRADITION COMPLET 110G", unit: "CARTOON", condit: 80, price: 2.77 },
            { name: "DOUBLE PAIN SW TRADITION NAT 110G", unit: "CARTOON", condit: 80, price: 2.22 }
        ],
        viennoiserie: [
            { name: "PAIN CHOC MARG PP", unit: "CARTOON", condit: 60, price: 3.15 },
            { name: "CROISSANT MARG PP", unit: "CARTOON", condit: 60, price: 2.75 },
            { name: "ESCARGOT RAISIN MARG PP", unit: "CARTOON", condit: 60, price: 3.15 },
            { name: "CROISSANT MARG MINI PP", unit: "CARTOON", condit: 160, price: 1.60 },
            { name: "PAIN CHOC MARG MINI PP", unit: "CARTOON", condit: 160, price: 1.70 },
            { name: "ESCARGOT RAISIN MARG MINI PP", unit: "CARTOON", condit: 160, price: 1.70 },
            { name: "MINI PAIN SUISSE SPECIAL PP", unit: "CARTOON", condit: 200, price: 2.64 },
            { name: "PLAQUE PATE FEUILLETE STD 40*60", unit: "CARTOON", condit: 20, price: 21.21 },
            { name: "PAIN CHOC BEURRE MINI PRET A CUIRE", unit: "CARTOON", condit: 160, price: 2.73 },
            { name: "PAIN CHOC BEURRE PRET A CUIRE", unit: "CARTOON", condit: 60, price: 5.57 },
            { name: "CROISSANT BEURRE PRET A CUIRE", unit: "CARTOON", condit: 60, price: 5.23 },
            { name: "CROISSANT BEURRE MINI PRET A CUIRE", unit: "CARTOON", condit: 160, price: 2.53 },
            { name: "DOUBLE PAIN CHOC BEURRE PRET A CUIRE", unit: "CARTOON", condit: 120, price: 5.57 },
            { name: "ESCARGOT RSN BEURRE MINI PRE-POUSSE", unit: "CARTOON", condit: 160, price: 2.73 }
        ],
        seminaire: [
            { name: "AUMONIERE POULET TANDOORI", unit: "CARTOON", condit: 200, price: 4.05 },
            { name: "GOUGERE JAMBON DINDE", unit: "CARTOON", condit: 200, price: 3.10 },
            { name: "FEUILLETE CHAUSSON CREVETTE MINI", unit: "CARTOON", condit: 200, price: 8.64 },
            { name: "FEUILLETEE SAUCISSE COCKTAIL", unit: "CARTOON", condit: 200, price: 3.27 },
            { name: "PF MACARON CHOC MINI", unit: "CARTOON", condit: 1, price: 183.89 },
            { name: "MINI PIZZA JAMB", unit: "CARTOON", condit: 200, price: 3.73 },
            { name: "MINI CHOUX GAMBAS", unit: "CARTOON", condit: 200, price: 4.26 },
            { name: "MINI BOURSE FETA EPINARD", unit: "CARTOON", condit: 200, price: 3.04 },
            { name: "QUICHE LORRAINE MINI", unit: "CARTOON", condit: 200, price: 2.47 },
            { name: "MINI TIGRE SAUMON", unit: "CARTOON", condit: 200, price: 3.04 },
            { name: "MINI VOL-AU-VENT CARRE CHAMPIGNONS TRUFFE", unit: "CARTOON", condit: 200, price: 3.92 },
            { name: "MINI FOND DE TARTE CARRE EVAS√â NEUTRE", unit: "CARTOON", condit: 300, price: 1.46 },
            { name: "MINI FOND DE TARTE ROND EVAS√â NEUTRE", unit: "CARTOON", condit: 350, price: 1.46 },
            { name: "PF MACARON CARAMEL SESAME", unit: "CARTOON", condit: 55, price: 4.18 },
            { name: "PF MACARON CHOCOLAT", unit: "CARTOON", condit: 55, price: 4.18 },
            { name: "PF MACARON VANILLE", unit: "CARTOON", condit: 55, price: 4.18 },
            { name: "PF MACARON PISTACHE", unit: "CARTOON", condit: 55, price: 4.18 },
            { name: "PF MACARON CAFE", unit: "CARTOON", condit: 55, price: 4.18 },
            { name: "PF MACARON CITRON", unit: "CARTOON", condit: 55, price: 4.18 },
            { name: "PF TIGRE MINI FINANCIER CHOC", unit: "CARTOON", condit: 4, price: 193.28 },
            { name: "PF MACARON FRAMBOISE", unit: "CARTOON", condit: 55, price: 4.18 },
            { name: "FONDANT CHOC MINI", unit: "CARTOON", condit: 80, price: 2.87 },
            { name: "PF DIAMANT PEPITE", unit: "CARTOON", condit: 5, price: 111.27 },
            { name: "PF FINANCIER MINI", unit: "CARTOON", condit: 4, price: 167.78 },
            { name: "TARTE PATE SUCREE PF", unit: "CARTOON", condit: 378, price: 1.67 }
        ],
        patisserie: [
            { name: "CAKE MARBRE", unit: "CARTOON", condit: 6, price: 37.69 },
            { name: "CAKE NAT", unit: "CARTOON", condit: 6, price: 35.67 },
            { name: "MUFFIN EXTRA CHOCOLAT", unit: "CARTOON", condit: 20, price: 17.37 },
            { name: "MUFFIN CITRON", unit: "CARTOON", condit: 20, price: 11.83 },
            { name: "PF FINANCIER GR", unit: "CARTOON", condit: 120, price: 5.68 },
            { name: "PF TIGRE FINANCIER CHOC", unit: "CARTOON", condit: 80, price: 7.71 },
            { name: "MUFFIN FRUIT ROUGE", unit: "CARTOON", condit: 20, price: 17.43 },
            { name: "MADELEINE IND", unit: "CARTOON", condit: 140, price: 3.01 },
            { name: "BROWNIE", unit: "CARTOON", condit: 48, price: 13.91 }
        ],
        snacking: [
            { name: "QUICHE LORRAINE IND", unit: "CARTOON", condit: 45, price: 25.38 },
            { name: "QUICHE SAUMON EPINARD IND", unit: "CARTOON", condit: 45, price: 27.24 },
            { name: "QUICHE POULET CHAMPIGNON IND", unit: "CARTOON", condit: 45, price: 19.42 }
        ],
        meat: [
            { name: "COQUELET CONGELE", unit: "SAC/P", condit: 1, price: 26.00 },
            { name: "CUISSE DE POULET CONGELE", unit: "SAC/KG", condit: 1, price: 40.00 },
            { name: "ESCALOPE DE DINDE CONGELE", unit: "SAC/KG", condit: 1, price: 55.00 },
            { name: "ESCALOPE PLT NG PANE SURGELE", unit: "SAC/KG", condit: 1, price: 52.00 },
            { name: "FILET DE PLT/SUPREME CONGELE", unit: "SAC/KG", condit: 1, price: 60.00 },
            { name: "FILET PLT CONGELE/ESCALOPE", unit: "SAC/KG", condit: 1, price: 60.00 },
            { name: "JAMBON PLT FUME", unit: "1KG", condit: 1, price: 60.00 },
            { name: "JAMBON PLT NAT", unit: "1KG", condit: 1, price: 55.00 },
            { name: "MERGUEZ DE PLT CONGELE", unit: "SAC/KG", condit: 1, price: 43.00 },
            { name: "MERGUEZ DOUCE DE PLT CONGELE", unit: "SAC/KG", condit: 1, price: 43.00 },
            { name: "MORTADELLE PLT NAT", unit: "1KG", condit: 1, price: 25.00 },
            { name: "MORTADELLE PLT OLIVES", unit: "500G", condit: 1, price: 25.00 },
            { name: "NUGGETS DE PLT CONGELE", unit: "SAC/KG", condit: 1, price: 52.00 },
            { name: "PILON PLT CONGELE", unit: "SAC/KG", condit: 1, price: 48.00 },
            { name: "POULET PAC CONGELE", unit: "SAC AAV X1", condit: 1, price: 30.00 },
            { name: "SAUCISSES PLT/ A GRILLER CONGELE", unit: "SAC/KG", condit: 1, price: 43.00 },
            { name: "SAUCISSES PLT / AIL & F;H CONGELE", unit: "SAC/KG", condit: 1, price: 43.00 },
            { name: "WINGS PLT / NAT CONGELE", unit: "SAC/KG", condit: 1, price: 29.00 }
        ],
        fries: [
            { name: "FRITE 7/7", unit: "SAC 2, 5 KG", condit: 1, price: 43.75 }
        ],
        ice: [
            { name: "GLACON 1 KG", unit: "SAC 1 KG", condit: 1, price: 8.00 },
            { name: "GLACON 2 KG", unit: "SAC 2 KG", condit: 1, price: 16.00 },
            { name: "GLACON 5 KG", unit: "SAC 5 KG", condit: 1, price: 40.00 }
        ]
    };

    let items = [];
    let currentTab = 'all'; // Default to show all
    const ITEMS_PER_PAGE = 13; // Pagination limit

    // --- INIT ---
    window.onload = function() {
        document.getElementById('dateInput').valueAsDate = new Date();
        
        // Restore Client Info
        if(localStorage.getItem('horeca_cName')) document.getElementById('clientName').value = localStorage.getItem('horeca_cName');
        if(localStorage.getItem('horeca_cAddr')) document.getElementById('clientAddress').value = localStorage.getItem('horeca_cAddr');
        if(localStorage.getItem('horeca_cIce')) document.getElementById('clientIce').value = localStorage.getItem('horeca_cIce');

        renderCatalog();
        updateUI(); 
        
        // Initial fit
        setTimeout(fitPageToScreen, 500);
    };
    
    // --- AUTO ZOOM SCALING FUNCTION ---
    function fitPageToScreen() {
        const container = document.querySelector('.preview-area');
        const pages = document.querySelectorAll('.a4-page');
        
        if (!container || pages.length === 0) return;
        
        // A4 width in pixels at 96 DPI is approx 794px (210mm)
        // We want to fit this into the container width minus padding
        const containerWidth = container.clientWidth;
        const paperWidth = pages[0].offsetWidth || 794; 
        
        // Add some padding (e.g., 20px total)
        const availableWidth = containerWidth - 20; 
        
        let scale = 1;
        
        // If container is smaller than paper, calculate scale
        if (availableWidth < paperWidth) {
            scale = availableWidth / paperWidth;
        }
        
        // Apply scale to all pages
        pages.forEach(page => {
            page.style.transform = `scale(${scale})`;
            // Fix layout flow: scaling leaves empty space below because element size doesn't change in DOM flow
            // We need to reduce margin-bottom to pull up content
            const height = page.offsetHeight;
            const scaledHeight = height * scale;
            const spaceToRemove = height - scaledHeight;
            
            page.style.marginBottom = `-${spaceToRemove}px`;
        });
    }

    // Call resize function on window resize
    window.addEventListener('resize', fitPageToScreen);

    // --- SEARCH LOGIC ---
    function searchProducts() {
        const query = document.getElementById('searchCatalog').value.toLowerCase();
        renderCatalog(query);
    }

    // --- TAB LOGIC ---
    function setTab(cat, el) {
        currentTab = cat;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('searchCatalog').value = ''; // Clear search on tab switch
        renderCatalog();
    }

    function renderCatalog(searchQuery = '') {
        const container = document.getElementById('catalogArea');
        container.innerHTML = '';
        
        const docType = document.getElementById('docTypeInput').value;
        const isEchantillon = docType === "Bon d'√âchantillon";

        let productsToShow = [];

        if (currentTab === 'all') {
            // Flatten all categories
            Object.values(catalog).forEach(catList => {
                productsToShow = productsToShow.concat(catList);
            });
        } else {
            productsToShow = catalog[currentTab] || [];
        }

        // Apply Search Filter
        if (searchQuery) {
            productsToShow = productsToShow.filter(p => p.name.toLowerCase().includes(searchQuery));
        }
        
        productsToShow.forEach((p, index) => {
            const el = document.createElement('div');
            el.className = 'prod-card-large';
            
            // Build footer based on mode
            let footerHTML = '';
            let topContent = '';

            if (isEchantillon) {
                // ECHANTILLON MODE: Only Name in Top. Dropdown in Footer.
                topContent = `<div class="font-bold text-gray-800 text-sm leading-snug mb-1 line-clamp-3" title="${p.name}">${p.name}</div>`;
                
                footerHTML = `
                    <div class="card-footer flex-col gap-2 !h-auto !py-2">
                        <select id="unit-${index}-${currentTab}" class="w-full text-xs p-1 border rounded bg-white outline-none text-gray-700 font-medium h-8 cursor-pointer" onclick="event.stopPropagation()">
                            <option value="" disabled selected>Choisir Unit√©</option>
                            <option value="Pi√®ces">Pi√®ces</option>
                            <option value="Sac">Sac</option>
                            <option value="Carton">Carton</option>
                            <option value="Unit√©">Unit√©</option>
                        </select>
                        
                        <div class="flex items-center gap-1 w-full justify-end card-controls">
                            <input type="number" id="qty-${index}-${currentTab}" value="1" min="1" step="1" 
                                class="w-12 h-8 text-center border rounded text-sm font-bold bg-gray-50 outline-none focus:border-blue-500" 
                                onclick="event.stopPropagation()">
                            <button class="bg-blue-600 text-white h-8 px-3 rounded text-xs font-bold hover:bg-blue-700 flex items-center gap-1 transition-colors shadow-sm"
                                onclick="event.stopPropagation(); addItemFromCard(this, '${index}-${currentTab}')">
                                <i class="fa-solid fa-plus"></i> Ajouter
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // NORMAL MODE: Name + Unit in Top. Price in Footer.
                topContent = `
                    <div class="font-bold text-gray-800 text-sm leading-snug mb-1 line-clamp-3" title="${p.name}">${p.name}</div>
                    <div class="text-xs text-gray-500">
                        <span class="bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200 whitespace-nowrap">
                            ${p.unit} (x${p.condit})
                        </span>
                    </div>
                `;
                
                footerHTML = `
                    <div class="card-footer">
                        <div class="text-blue-700 font-extrabold text-sm whitespace-nowrap">${p.price.toFixed(2)} DHS</div>
                        
                        <div class="flex items-center gap-1 card-controls">
                            <input type="number" id="qty-${index}-${currentTab}" value="1" min="1" step="1" 
                                class="w-10 h-8 text-center border rounded text-sm font-bold bg-gray-50 outline-none focus:border-blue-500" 
                                onclick="event.stopPropagation()">
                            <button class="bg-blue-600 text-white h-8 px-2 rounded text-xs font-bold hover:bg-blue-700 flex items-center gap-1 transition-colors shadow-sm"
                                onclick="event.stopPropagation(); addItemFromCard(this, '${index}-${currentTab}')">
                                <i class="fa-solid fa-plus"></i> Ajouter
                            </button>
                        </div>
                    </div>
                `;
            }

            el.innerHTML = `
                <div class="card-top">
                    ${topContent}
                </div>
                ${footerHTML}
            `;
            // Store product data on button
            const btn = el.querySelector('button');
            btn.productData = p;
            
            container.appendChild(el);
        });

        if (productsToShow.length === 0) {
            container.innerHTML = `<div class="col-span-3 text-center text-gray-400 py-10">Aucun produit trouv√©.</div>`;
        }
    }

    // --- TOAST FUNCTION ---
    function showToast(message) {
        const toast = document.getElementById("toast");
        document.getElementById("toast-message").innerText = message;
        toast.className = "toast show";
        setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
    }

    function addItemFromCard(btn, idSuffix) {
        const p = btn.productData;
        const qtyInput = document.getElementById(`qty-${idSuffix}`);
        const qty = parseFloat(qtyInput.value) || 1;
        
        // Check for custom unit (Echantillon mode)
        let customUnit = null;
        const unitSelect = document.getElementById(`unit-${idSuffix}`);
        if(unitSelect) {
            customUnit = unitSelect.value;
            if(!customUnit) {
                alert("Veuillez choisir une unit√© (Pi√®ces, Sac, Carton, etc.)");
                return; // Stop if no unit selected
            }
        }
        
        addItem(p, qty, customUnit);
    }

    function addItem(p, qty = 1, customUnit = null) {
        // If customUnit is provided (Echantillon mode), we treat it as a separate item or update that specific one
        
        let itemToAdd = { ...p, qty: qty };
        if(customUnit) {
            itemToAdd.unit = customUnit; // Override unit
            itemToAdd.price = 0; // Ensure 0 price for sample
        }

        // Logic: if same item AND same unit exists, update qty
        const existing = items.find(i => i.name === itemToAdd.name && i.unit === itemToAdd.unit);
        
        if(existing) {
            existing.qty += qty;
        } else {
            items.push(itemToAdd);
        }
        
        showToast(`${qty}x ${p.name} ajout√© !`);
        renderInvoice();
    }

    function addManual() {
        const name = document.getElementById('mName').value;
        const docType = document.getElementById('docTypeInput').value;
        const isEchantillon = docType === "Bon d'√âchantillon";
        
        let price = 0;
        let unit = "U";
        let condit = 1;

        if(isEchantillon) {
             // In Echantillon mode, price is always 0. Unit comes from dropdown (we need to read manual unit)
             // For manual add in Echantillon, we repurposed mPrice for Unit input in the UI logic below
             const unitSelect = document.getElementById('mUnitSelect');
             if(unitSelect) unit = unitSelect.value;
             if(!unit && isEchantillon) unit = "Pi√®ces"; // Default
        } else {
             price = parseFloat(document.getElementById('mPrice').value);
             unit = document.getElementById('mUnit').value || "U";
             condit = parseFloat(document.getElementById('mCondit').value) || 1;
        }
        
        if(name) {
            addItem({name, price, unit, condit}, 1); 
            document.getElementById('mName').value = '';
            if(!isEchantillon) document.getElementById('mPrice').value = '';
        }
    }

    function updateQty(idx, val) {
        if(val <= 0) items.splice(idx, 1);
        else items[idx].qty = parseFloat(val);
        renderInvoice();
    }

    function toggleModal(show) {
        const modal = document.getElementById('productModal');
        if(show) {
            modal.classList.add('open');
            renderCatalog(); // Re-render to check mode (Echantillon vs Normal)
        }
        else modal.classList.remove('open');
    }

    // --- RENDER INVOICE & PAGINATION ---
    function renderInvoice() {
        // SAVE INFO
        localStorage.setItem('horeca_cName', document.getElementById('clientName').value);
        localStorage.setItem('horeca_cAddr', document.getElementById('clientAddress').value);
        localStorage.setItem('horeca_cIce', document.getElementById('clientIce').value);

        const container = document.getElementById('pages-container');
        container.innerHTML = ''; // Clear pages

        // Gather Inputs
        const docType = document.getElementById('docTypeInput').value;
        const inputs = {
            docType: docType,
            date: formatDate(document.getElementById('dateInput').value),
            docNum: document.getElementById('docNumInput').value,
            ref: document.getElementById('refInput').value || "-",
            payment: document.getElementById('paymentInput').value || "-",
            cName: document.getElementById('clientName').value || "NOM DU CLIENT",
            // No replacement needed for text input, let CSS handle wrapping
            cAddr: document.getElementById('clientAddress').value || "Adresse du client...",
            cIce: document.getElementById('clientIce').value || "-",
            savedLogo: localStorage.getItem('horeca_logo')
        };

        const isEchantillon = (docType === "Bon d'√âchantillon");

        // Logic variables
        let total = 0;
        let cartonCount = 0;
        let totalUnitsCount = 0; // For Echantillon total units
        
        // Calculate Totals first
        items.forEach(i => {
            const totU = i.qty * i.condit;
            const linePrice = totU * i.price;
            total += linePrice;
            
            totalUnitsCount += totU; // Sum all individual units

            // IMPROVED LOGIC FOR COUNTING CARTONS
            const unitUpper = i.unit.toUpperCase();
            if(unitUpper.includes('CARTON') || unitUpper.includes('CARTOON') || (unitUpper === 'CTN') || (unitUpper === 'C/40') || (i.condit > 1 && unitUpper !== 'KG' && unitUpper !== 'L')) {
                cartonCount += i.qty;
            }
            
            i.lineTotal = linePrice; // Store for rendering
            i.totU = totU;
        });

        // Split into Chunks
        const chunks = [];
        if(items.length === 0) {
            chunks.push([]); // Empty page
        } else {
            for (let i = 0; i < items.length; i += ITEMS_PER_PAGE) {
                chunks.push(items.slice(i, i + ITEMS_PER_PAGE));
            }
        }

        // Render Pages
        chunks.forEach((chunk, index) => {
            const isLast = index === chunks.length - 1;
            const pageHTML = buildPageHTML(chunk, index, chunks.length, isLast, inputs, total, cartonCount, totalUnitsCount, isEchantillon);
            container.insertAdjacentHTML('beforeend', pageHTML);
        });

        // Re-attach logo
        if(inputs.savedLogo) {
            document.querySelectorAll('.page-logo').forEach(img => {
                img.src = inputs.savedLogo;
                img.classList.remove('hidden');
            });
        }
        
        // Trigger scaling after render
        setTimeout(fitPageToScreen, 100);
    }

    function buildPageHTML(chunk, pageIdx, totalPages, isLast, inputs, grandTotal, cartonCount, totalUnitsCount, isEchantillon) {
        let rowsHTML = '';
        
        // Render Rows
        chunk.forEach((item, chunkIdx) => {
            const absIdx = (pageIdx * ITEMS_PER_PAGE) + chunkIdx;
            
            if (isEchantillon) {
                // ECHANTILLON ROW: Simplified
                rowsHTML += `
                    <tr class="row-stripe">
                        <td class="col-art">${item.name}</td>
                        <td>${item.unit}</td>
                        <td style="padding:0">
                            <input type="number" class="w-12 text-center bg-transparent font-bold text-blue-700" 
                            value="${item.qty}" onchange="updateQty(${absIdx}, this.value)">
                        </td>
                        <td class="no-print text-red-500 cursor-pointer" onclick="updateQty(${absIdx}, 0)"><i class="fa-solid fa-trash"></i></td>
                    </tr>
                `;
            } else {
                // NORMAL ROW
                rowsHTML += `
                    <tr class="row-stripe">
                        <td class="col-art">${item.name}</td>
                        <td>${item.unit}</td>
                        <td style="padding:0">
                            <input type="number" class="w-12 text-center bg-transparent font-bold text-blue-700" 
                            value="${item.qty}" onchange="updateQty(${absIdx}, this.value)">
                        </td>
                        <td>${item.condit}</td>
                        <td>${item.totU}</td>
                        <td>${item.price.toFixed(2)}</td>
                        <td class="font-bold">${item.lineTotal.toFixed(2)}</td>
                        <td class="no-print text-red-500 cursor-pointer" onclick="updateQty(${absIdx}, 0)"><i class="fa-solid fa-trash"></i></td>
                    </tr>
                `;
            }
        });

        // NO EMPTY ROWS ADDED - Loop removed

        // Header Logic
        let headerColsHTML = '';
        if (isEchantillon) {
            headerColsHTML = `
                <th class="col-art">D√©signation</th>
                <th width="15%">Unit√©</th>
                <th width="15%">Qt√©</th>
                <th width="5%" class="no-print"></th>
            `;
        } else {
            headerColsHTML = `
                <th class="col-art">D√©signation</th>
                <th width="8%">Unit√©</th>
                <th width="8%">Qt√©</th>
                <th width="8%">Condit</th>
                <th width="10%">Total U</th>
                <th width="12%">P.U (DH)</th>
                <th width="15%">Total (DH)</th>
                <th width="5%" class="no-print"></th>
            `;
        }

        // Info Bar Logic
        let infoBarHTML = '';
        if (isEchantillon) {
            // Hide NB UNITES for Echantillon per request
            // Also remove redundant divs to fix empty space
            infoBarHTML = `
                <div class="info-cell">
                    <div class="info-header">Date</div>
                    <div class="info-value">${inputs.date}</div>
                </div>
                <div class="info-cell">
                    <div class="info-header">N¬∞ BE</div>
                    <div class="info-value">${inputs.docNum}</div>
                </div>
                <div class="info-cell">
                    <div class="info-header">R√©f√©rence</div>
                    <div class="info-value">${inputs.ref}</div>
                </div>
            `;
        } else {
            const dynamicLabel = inputs.docType === 'Facture' ? "Mode Paiement" : "NB UNIT√âS";
            const dynamicVal = inputs.docType === 'Facture' ? inputs.payment : cartonCount;
            const dateLabel = inputs.docType === 'Facture' ? "Date Facturation" : "Date Livraison";
            const numLabel = inputs.docType === 'Facture' ? "N¬∞ Facture" : "N¬∞ BL";

            infoBarHTML = `
                <div class="info-cell">
                    <div class="info-header">${dateLabel}</div>
                    <div class="info-value">${inputs.date}</div>
                </div>
                <div class="info-cell">
                    <div class="info-header">${numLabel}</div>
                    <div class="info-value">${inputs.docNum}</div>
                </div>
                <div class="info-cell">
                    <div class="info-header">${dynamicLabel}</div>
                    <div class="info-value">${dynamicVal}</div>
                </div>
                <div class="info-cell">
                    <div class="info-header">R√©f√©rence</div>
                    <div class="info-value">${inputs.ref}</div>
                </div>
            `;
        }

        // Footer Logic (Total only for non-Echantillon)
        let footerHTML = '';
        if (isLast) {
            if (!isEchantillon) {
                const words = numberToFrench(grandTotal);
                const wordStr = words.charAt(0).toUpperCase() + words.slice(1);
                
                footerHTML = `
                    <div class="footer-area">
                        <div class="amount-text">
                            <div class="text-sm font-bold text-gray-600 border-b pb-1 mb-1 uppercase">Montant de Facture en lettre:</div>
                            <div class="amount-words">${wordStr}</div>
                        </div>
                        <div class="total-box">
                            <div class="total-row final">
                                <span class="total-label">NET √Ä PAYER</span>
                                <div class="total-value-group">
                                    <span class="total-value-main">${grandTotal.toLocaleString('fr-MA', {minimumFractionDigits: 2})}</span>
                                    <span class="total-currency">DH</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Echantillon footer spacer
                footerHTML = `<div style="height: 50px;"></div>`;
            }
        } else {
            footerHTML = `<div class="page-break-text">... Suite page suivante ...</div>`;
        }

        return `
        <div class="a4-page">
            <!-- HEADER -->
            <div class="header-top">
                <div class="logo-area">
                    <img class="page-logo logo-img hidden" alt="Logo">
                    <div class="vendor-name text-blue-800 font-bold text-xl mb-1">HORECA SOUTH WAVE SARL</div>
                    <div class="vendor-details">
                        AV. ABDELKHALEK<br>
                        TORRESSE N¬∞ 181<br>
                        RC N¬∞: 30223<br>
                        I.C.E: 003759201000045
                    </div>
                </div>
                <div class="client-box">
                    <div class="client-label">Destinataire:</div>
                    <div class="font-bold text-lg text-blue-900 mb-1">${inputs.cName}</div>
                    <div class="text-sm text-gray-600 mb-2 whitespace-pre-line" style="word-break: break-word;">${inputs.cAddr}</div>
                    <div class="text-sm font-bold">ICE: ${inputs.cIce}</div>
                </div>
            </div>

            <div class="doc-title-row">
                <div class="doc-title">${inputs.docType.toUpperCase()}</div>
                <div class="text-xs text-gray-500 mt-1">Page ${pageIdx + 1} / ${totalPages}</div>
            </div>

            <div class="info-bar">
                ${infoBarHTML}
            </div>

            <!-- Flex container for table content to push footer down -->
            <div class="flex flex-col content-spacer">
                <table class="main-table">
                    <thead>
                        <tr>
                            ${headerColsHTML}
                        </tr>
                    </thead>
                    <tbody>
                        ${rowsHTML}
                    </tbody>
                </table>
            </div>

            ${footerHTML}

            <div class="bottom-info">
                <div>
                    <strong class="text-blue-900">HORECA SOUTH WAVE SARL</strong><br>
                    Distribution agro-alimentaire<br>
                    T√©l: +212 6 61 37 26 24<br>
                    contact@horecasw.com<br>
                    www.horecasw.com
                </div>
                <div class="text-right" style="font-size: 8.5pt;">
                    <strong class="text-blue-900">D√©tails bancaires:</strong><br>
                    Banque : <strong>AttijariWafa bank</strong><br>
                    N de compte : 0015185000000702<br>
                    IBAN : MA64 007 530 0015185000000702 57
                </div>
            </div>
        </div>
        `;
    }

    // --- UTILS ---
    function updateUI() {
        const type = document.getElementById('docTypeInput').value;
        const isFacture = type === 'Facture';
        const isEchantillon = type === "Bon d'√âchantillon";
        
        document.getElementById('paymentInput').classList.toggle('hidden', !isFacture);
        
        // Toggle Manual Add Inputs for Echantillon
        const manualUnitDiv = document.getElementById('manualUnitContainer');
        const mPriceInput = document.getElementById('mPrice');
        const mConditInput = document.getElementById('mCondit');
        
        if(isEchantillon) {
            // Hide Price & Condit for Echantillon Manual Add
            mPriceInput.classList.add('hidden');
            mConditInput.classList.add('hidden');
            // Swap Text Unit for Select Unit
            manualUnitDiv.innerHTML = `
                <select id="mUnitSelect" class="w-full text-xs p-1 border rounded bg-white outline-none h-[42px]">
                    <option value="Pi√®ces">Pi√®ces</option>
                    <option value="Sac">Sac</option>
                    <option value="Carton">Carton</option>
                    <option value="Unit√©">Unit√©</option>
                </select>`;
        } else {
            mPriceInput.classList.remove('hidden');
            mConditInput.classList.remove('hidden');
            manualUnitDiv.innerHTML = `<input id="mUnit" placeholder="Unit√©" class="w-full text-xs">`;
        }

        renderInvoice();
    }

    function loadLogo(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    localStorage.setItem('horeca_logo', e.target.result);
                    renderInvoice();
                } catch(e) { console.warn("Logo too big"); }
            }
            reader.readAsDataURL(file);
        }
    }

    function generatePDF() {
        // 1. Reset Scale for full resolution capture
        const pages = document.querySelectorAll('.a4-page');
        pages.forEach(p => {
            p.style.transform = 'none';
            p.style.marginBottom = '0';
        });

        const element = document.getElementById('pages-container');
        const opt = {
            margin: 0,
            filename: `${document.getElementById('docTypeInput').value}_${document.getElementById('clientName').value}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            // Add custom pagebreak settings to prevent extra page
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };
        
        document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
        
        html2pdf().set(opt).from(element).save().then(() => {
            document.querySelectorAll('.no-print').forEach(el => el.style.display = '');
            // Restore scale for mobile viewing
            fitPageToScreen();
        });
    }

    function formatDate(dateStr) {
        if(!dateStr) return "-";
        const d = new Date(dateStr);
        return d.toLocaleDateString('fr-FR');
    }

    function numberToFrench(num) {
        if (num === 0) return "z√©ro dirhams";
        const units = ["", "un", "deux", "trois", "quatre", "cinq", "six", "sept", "huit", "neuf"];
        const teens = ["dix", "onze", "douze", "treize", "quatorze", "quinze", "seize", "dix-sept", "dix-huit", "dix-neuf"];
        const tens = ["", "dix", "vingt", "trente", "quarante", "cinquante", "soixante", "soixante-dix", "quatre-vingt", "quatre-vingt-dix"];
        function convertGroup(n) {
            if (n < 10) return units[n];
            if (n < 20) return teens[n - 10];
            if (n < 100) {
                let ten = Math.floor(n / 10);
                let unit = n % 10;
                if (ten === 7 || ten === 9) { ten -= 1; unit += 10; }
                let str = tens[ten];
                if (unit === 0) return str;
                if (unit === 1 && ten !== 8) return str + " et un";
                if (unit >= 10) return str + "-" + teens[unit - 10];
                return str + "-" + units[unit];
            }
            if (n < 1000) {
                let hundred = Math.floor(n / 100);
                let rest = n % 100;
                let str = (hundred === 1 ? "cent" : units[hundred] + " cent");
                if (rest === 0) return str;
                return str + " " + convertGroup(rest);
            }
            return "";
        }
        let integerPart = Math.floor(num);
        let decimalPart = Math.round((num - integerPart) * 100);
        let result = "";
        if (integerPart >= 1000) {
            let thousands = Math.floor(integerPart / 1000);
            integerPart %= 1000;
            if (thousands === 1) result += "mille ";
            else result += convertGroup(thousands) + " mille ";
        }
        if (integerPart > 0) result += convertGroup(integerPart);
        else if (result === "") result += "z√©ro";
        result += " dirhams";
        if (decimalPart > 0) result += " et " + convertGroup(decimalPart) + " centimes";
        return result;
    }
</script>
</body>
</html>
